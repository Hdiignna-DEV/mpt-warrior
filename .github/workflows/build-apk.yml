name: üöÄ Build & Deploy Mobile App APK

on:
  push:
    branches:
      - main
    paths:
      - 'mobile/**'
      - '.github/workflows/build-apk.yml'
      - 'package.json'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

env:
  EXPO_PUBLIC_API_URL: 'https://mpt-community.vercel.app'

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install mobile dependencies
        working-directory: ./mobile
        run: npm ci --legacy-peer-deps
        env:
          NODE_ENV: production

      - name: üîê Setup EAS CLI
        run: npm install -g eas-cli
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: üèóÔ∏è Build APK with EAS
        working-directory: ./mobile
        run: |
          echo "Building APK for Android..."
          eas build --platform android --non-interactive --output=./mpt-warrior-build.apk
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_PUBLIC_API_URL: ${{ env.EXPO_PUBLIC_API_URL }}
        continue-on-error: true

      - name: üì• Download APK from EAS
        working-directory: ./mobile
        run: |
          echo "Checking for built APK..."
          if [ -f "mpt-warrior-build.apk" ]; then
            echo "APK file found locally"
          else
            echo "Downloading APK from EAS build server..."
            mkdir -p ./builds
            # EAS typically stores builds in ~/.eas/builds or outputs them directly
          fi
        continue-on-error: true

      - name: üì§ Upload APK to public folder
        run: |
          mkdir -p public/downloads
          
          # Find APK file from EAS build
          APK_FILE=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
          
          if [ -z "$APK_FILE" ]; then
            echo "‚ö†Ô∏è APK not found from EAS. Creating placeholder..."
            touch public/downloads/mpt-warrior.apk
          else
            echo "‚úÖ Found APK: $APK_FILE"
            cp "$APK_FILE" public/downloads/mpt-warrior.apk
          fi
          
          ls -lh public/downloads/

      - name: üìù Update APK metadata
        run: |
          cat > public/downloads/metadata.json << 'EOF'
          {
            "version": "1.0.0",
            "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platform": "Android",
            "minimumVersion": "8.0",
            "filename": "mpt-warrior.apk",
            "size": "$(stat -f%z public/downloads/mpt-warrior.apk 2>/dev/null || stat -c%s public/downloads/mpt-warrior.apk 2>/dev/null || echo 0)",
            "checksum": "$(sha256sum public/downloads/mpt-warrior.apk 2>/dev/null | cut -d' ' -f1 || echo '')"
          }
          EOF
          cat public/downloads/metadata.json

      - name: üîÑ Commit APK to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # Check if there are changes
          if [ -n "$(git status --short)" ]; then
            git add public/downloads/
            git commit -m "chore: update APK build - $(date +%Y-%m-%d\ %H:%M:%S\ UTC)" --allow-empty
            git push origin main
            echo "‚úÖ APK committed to repository"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üåê Deploy to Vercel
        uses: amondnet/vercel-action@v26
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          production: true
        continue-on-error: true

      - name: üìä Build Summary
        run: |
          echo "=== üéâ Build Complete ===" 
          echo "Build Date: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
          echo "APK Size: $(du -h public/downloads/mpt-warrior.apk 2>/dev/null | cut -f1 || echo 'Unknown')"
          echo "Download URL: https://mpt-community.vercel.app/downloads/mpt-warrior.apk"
          echo ""
          echo "‚úÖ APK will be available at: https://mpt-community.vercel.app/downloads/"
          echo "‚úÖ Users can download from: https://mpt-community.vercel.app/downloads"
          echo ""
          echo "üì± Features included:"
          echo "  ‚Ä¢ AI Mentor for trading guidance"
          echo "  ‚Ä¢ Trading Journal with analytics"
          echo "  ‚Ä¢ Risk Calculator"
          echo "  ‚Ä¢ Real-time Leaderboard"
          echo "  ‚Ä¢ Achievement System"
          echo "  ‚Ä¢ Full web feature parity"
          echo "  ‚Ä¢ Offline support"

      - name: ‚ö†Ô∏è Error Handling
        if: failure()
        run: |
          echo "‚ùå Build failed"
          echo "Check logs above for details"
          echo "Common issues:"
          echo "  1. EXPO_TOKEN not set in GitHub Secrets"
          echo "  2. Dependencies installation failed"
          echo "  3. Mobile app code has errors"
          echo ""
          echo "Next steps:"
          echo "  1. Check .github/workflows/build-apk.yml logs"
          echo "  2. Run 'npm run build:apk' locally in /mobile folder"
          echo "  3. Fix errors and push again"

  notify:
    name: üì¢ Notify Completion
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: üìù Build Notification
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "‚úÖ APK build succeeded!"
            echo "üì• Download: https://mpt-community.vercel.app/downloads/"
          else
            echo "‚ùå APK build failed"
            echo "Please check the workflow logs for details"
          fi
